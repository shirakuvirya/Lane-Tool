<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WaypointEdit+ - Complete Point Cloud Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div id="app"></div>

    <div id="selection-box"></div>

    <div id="loader">Loading WaypointEdit+...</div>

    <div id="top-tabs">
        <div class="tab-nav">
            <button id="tab-view" class="tab-button active">
                <span class="tab-icon">üëÅÔ∏è</span>
                View
            </button>
            <button id="tab-waypoint-edit" class="tab-button">
                <span class="tab-icon">üìç</span>
                Waypoint Edit
            </button>
            <button id="tab-lane-edit" class="tab-button">
                <span class="tab-icon">üõ£Ô∏è</span>
                Lane Edit
            </button>
            <button id="tab-layout-drawings" class="tab-button">
                <span class="tab-icon">üìê</span>
                Layout Drawings
            </button>
        </div>

        <div id="file-control">
            <label class="file-label">
                üìÅ Load PCD/PLY
                <input type="file" id="pcd-file" accept=".pcd,.ply" multiple>
            </label>
            <label class="file-label">
                üóÑÔ∏è Load Database
                <input type="file" id="db-file" accept=".db,.sqlite,.sqlite3">
            </label>
        </div>
    </div>

    <div id="left-panel" class="side-panel hidden">
        <div class="panel-header">
            <h3>WaypointEdit+ Tools</h3>
        </div>

        <div class="tool-section">
            <h4>Edit Tools</h4>
            <div class="tool-grid">
                <button id="tool-add-points" class="tool-button" title="Add waypoints by clicking">
                    <span class="tool-icon">‚ûï</span>
                    Add Points
                </button>
                <button id="tool-remove-points" class="tool-button" title="Remove waypoints by clicking">
                    <span class="tool-icon">üóëÔ∏è</span>
                    Remove Points
                </button>
                <button id="tool-move-points" class="tool-button" title="Select and move waypoints">
                    <span class="tool-icon">üîÑ</span>
                    Move Points
                </button>
                <button id="tool-interpolate" class="tool-button" title="Interpolate between two waypoints">
                    <span class="tool-icon">üìà</span>
                    Interpolate
                </button>
            </div>
            
        </div>

        <div id="interpolation-panel" class="tool-section hidden">
            <h4>Interpolation</h4>
            <p id="interpolation-info" class="panel-hint">Select a path of 3 or more points to interpolate.</p>
            <div class="actions">
                <button id="linear-interpolate" class="action-btn success" disabled>Linear Interpolate</button>
            </div>
            <h4 style="margin-top: 20px;">Radial Interpolation</h4>
            <div class="control-group">
                <label for="radial-strength">Strength</label>
                <input type="range" id="radial-strength" min="-5" max="5" step="0.1" value="0" disabled>
                <input type="text" id="radial-strength-value" value="0.00" style="width: 50px; text-align: center;" disabled>
            </div>
        </div>

        <div class="tool-section">
            <h4>Shortcuts</h4>
            <div class="shortcuts-info">
                <p><kbd>A</kbd> - Add Points</p>
                <p><kbd>D</kbd> - Remove Points</p>
                <p><kbd>M</kbd> - Move Points</p>
                <p><kbd>I</kbd> - Interpolate</p>
                <p><kbd>ESC</kbd> - Clear selection</p>
                <p><kbd>Del</kbd> - Delete selected</p>
            </div>
        </div>
    </div>

    <div id="right-panel" class="side-panel hidden">
        <div class="panel-header">
            <h3>Waypoint Info</h3>
        </div>

        <div id="waypoint-info" class="info-section hidden">
            <h4>Hovered Waypoint</h4>
            <div class="coord-display">
                <div class="coord-row">
                    <label>ID:</label>
                    <span id="waypoint-id">-</span>
                </div>
                <div class="coord-row">
                    <label>X:</label>
                    <span id="coord-x">0.000</span>
                </div>
                <div class="coord-row">
                    <label>Y:</label>
                    <span id="coord-y">0.000</span>
                </div>
                <div class="coord-row">
                    <label>Z:</label>
                    <span id="coord-z">0.000</span>
                </div>
            </div>
        </div>

        
        <div class="info-section">
            <h4>WaypointEdit+ Features</h4>
            <div class="instructions">
                <p>üéØ <strong>Hover</strong> over waypoints to see cyan ring</p>
                <p>üîç Ring appears around hovered waypoints</p>
                <p>üñ±Ô∏è <strong>Click</strong> waypoints to select them</p>
                <p>‚å®Ô∏è Use keyboard shortcuts for quick tool access</p>
                <p>‚ûï <strong>Add points</strong> by clicking on map</p>
                <p>üîÑ <strong>Move points</strong> with drag selection</p>
                <p>üìà <strong>Interpolate</strong> between waypoints</p>
            </div>
        </div>

        <div class="info-section">
            <h4>Statistics</h4>
            <div class="stats-display">
                <div class="stat-row">
                    <label>Total Waypoints:</label>
                    <span id="waypoint-count">0</span>
                </div>
            </div>
        </div>
    </div>

    <div id="left-lane-panel" class="side-panel hidden">
        <div class="panel-header">
            <h3>LaneEdit+ Tools</h3>
        </div>
        <div class="tool-section">
            <h4>Lane Generation</h4>
             <div class="lane-control">
                <label for="vehicle-select">Vehicle:</label>
                <select id="vehicle-select">
                    <option value="0.5">AMR-10 (0.5m)</option>
                    <option value="0.75">ARM-50 (0.75m)</option>
                    <option value="1.0" selected>Buggy (1.0m)</option>
                </select>
            </div>
            <div class="actions">
                <button id="generate-lane" class="action-btn action-gen-lane">Generate Lane</button>
            </div>
            <div class="actions">
                <button id="delete-lane" class="action-btn action-del-lane">X Delete Generated Lane</button>
            </div>
        </div>
        <div class="tool-section">
            <h4>Edit Lane</h4>
            <div class="actions">
                <button id="tool-edit-lane" class="action-btn action-gen-lane">Change Lane Width</button>
            </div>
            <div id="lane-width-editor" class="tool-section hidden">
                <h4>Left Segment Width</h4>
                 <div class="panel-control">
                    <label for="left-lane-width-input">Left Width (m):</label>
                    <div class="stepper-input">
                        <button id="left-width-decrease-btn" title="Decrease left width by 0.05m">&minus;</button>
                        <input type="text" id="left-lane-width-input" value="0.50">
                        <button id="left-width-increase-btn" title="Increase left width by 0.05m">&plus;</button>
                    </div>
                </div>
                <div class="panel-control">
                    <label for="right-lane-width-input">Right Width (m):</label>
                    <div class="stepper-input">
                        <button id="right-width-decrease-btn" title="Decrease right width by 0.05m">&minus;</button>
                        <input type="text" id="right-lane-width-input" value="0.50">
                        <button id="right-width-increase-btn" title="Increase right width by 0.05m">&plus;</button>
                    </div>
                </div>

                
            </div>
            
            <div id="lane-edit-info" class="info-display hidden">
                </div>
        </div>
    </div>

    <div id="right-lane-panel" class="side-panel hidden">
        <div class="panel-header">
            <h3>Lane Info</h3>
        </div>
        </div>


    <div id="left-layout-panel" class="side-panel hidden">
        <div class="panel-header">
            <h3>Layouts</h3>
        </div>
        <div class="tool-section">
            <h4>Add Element</h4>
            <div class="tool-grid">
               <button id="tool-add-square" class="tool-button" title="Add Rectangle">
                    <span class="tool-icon">‚ñ≠</span>
                    Rectangle
                </button>
                <button id="tool-add-oval" class="tool-button" title="Add Oval">
                    <span class="tool-icon">‚ö™</span>
                    Oval
                </button>
                <button id="tool-add-arrow" class="tool-button" title="Add Arrow">
                    <span class="tool-icon">‚¨ÜÔ∏è</span>
                    Arrow
                </button>
                <button id="tool-add-line" class="tool-button" title="Add Line">
                    <span class="tool-icon">üìè</span>
                    Line
                </button>
            </div>
             <div class="actions">
                <button id="layout-insert-text" class="action-btn action-gen-lane">Insert Text</button>
            </div>
        </div>
         <div class="tool-section">
            <h4>Edit Element</h4>
            <div class="tool-grid">
                 <button id="tool-select-shape" class="tool-button-layout" title="Select and Transform Shape">
                    <span class="tool-icon">üñêÔ∏è</span>
                    Select & Transform
                </button>
                <button id="layout-delete-element" class="tool-button-layout" title="Delete Selected Shape">
                    <span class="tool-icon">üóëÔ∏è</span>
                    Delete Selected
                </button>
                <button id="layout-edit-text" class="tool-button-layout " title="Edit Selected Text">
                    <span class="tool-icon">‚úèÔ∏è</span>
                    Edit Text
                </button>
            </div>
            <div id="style-controls" class="tool-section hidden">
                <h4>Element Style</h4>
                <div id="shape-style-controls" class="color-palette hidden">
                    <div class="color-control">
                        <label for="fill-color">Fill Color</label>
                        <input type="color" id="fill-color" value="#4a9eff">
                    </div>
                    <div class="color-control">
                        <label for="shape-opacity">Opacity</label>
                        <div class="slider-container">
                            <input type="range" id="shape-opacity" min="0" max="1" step="0.01" value="0.7">
                            <span id="shape-opacity-value">0.70</span>
                        </div>
                    </div>
                </div>
                <div id="text-style-controls" class="color-palette hidden">
                    <div class="color-control">
                        <label for="text-color">Text Color</label>
                        <input type="color" id="text-color" value="#ffffff">
                    </div>
                    <div class="color-control">
                        <label for="text-size">Text Size</label>
                        <div class="slider-container">
                            <input type="range" id="text-size" min="0.1" max="5" step="0.05" value="0.5">
                            <span id="text-size-value">0.50</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="right-layout-panel" class="side-panel hidden">
        <div class="panel-header">
            <h3>Layout Info</h3>
        </div>
    </div>

    <div id="hover-coords"></div>

    <div id="bottom-controls">
        <div class="control-group">
            <label>Point Size:</label>
            <input type="range" id="point-size" min="0.1" max="5" step="0.1" value="0.5">
            <span id="size-value">0.5</span>
        </div>

        <div class="control-group">
            <label>Voxel Size:</label>
            <input type="range" id="voxel-size" min="0.1" max="5" step="0.1" value="1.0">
            <span id="voxel-value">1.0</span>
        </div>

        <div class="control-group">
            <label>Opacity:</label>
            <input type="range" id="opacity" min="0" max="1" step="0.01" value="1">
            <span id="opacity-value">1.0</span>
        </div>

        <div class="control-group">
            <label>Waypoint Size:</label>
            <input type="range" id="waypoint-size" min="0.01" max="0.5" step="0.005" value="0.05">
            <span id="waypoint-size-value">0.05</span>
        </div>

        <div class="control-group">
            <label>Color:</label>
            <select id="color-mode">
                <option value="default">White</option>
                <option value="height">Height (Z)</option>
            </select>
        </div>

        <div class="control-group">
            <label>View:</label>
            <select id="view-mode">
                <option value="orbit">Orbit</option>
                <option value="top">Top</option>
            </select>
        </div>
    </div>

    <div id="text-input-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title">Enter Label Text</h3>
            <input type="text" id="text-input-field" placeholder="Your text here...">
            <div class="modal-actions">
                <button id="text-input-cancel" class="action-btn action-del-lane">Cancel</button>
                <button id="text-input-confirm" class="action-btn success">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>